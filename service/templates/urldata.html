<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›’è†œè½¨è¿¹è·Ÿè¸ªæŸ¥è¯¢</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #eaeaea; }
        .header { background: rgba(255,255,255,0.05); padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header h1 { font-size: 1.8rem; }
        .header a { color: #e94560; text-decoration: none; margin-left: 20px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .panel { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .panel-title { font-size: 1.1rem; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.2s; font-size: 0.85rem; }
        .btn-primary { background: #e94560; color: #fff; }
        .btn-primary:hover { background: #d63850; }
        .btn-secondary { background: #444; color: #fff; }
        .btn-secondary:hover { background: #555; }
        .btn-warning { background: #ffaa00; color: #000; }
        .btn-warning:hover { background: #e69900; }
        .btn-success { background: #22c55e; color: #fff; }
        .btn-success:hover { background: #16a34a; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-danger:hover { background: #dc2626; }
        .btn-block { width: 100%; padding: 10px; }
        .query-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
        .query-row:last-child { margin-bottom: 0; }
        .query-label { min-width: 70px; color: #aaa; font-size: 0.9rem; }
        .query-input { flex: 1; min-width: 150px; padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 6px; color: #fff; font-size: 0.9rem; }
        .query-input:focus { outline: none; border-color: #e94560; }
        select.query-input { cursor: pointer; }
        .stats-bar { background: rgba(0,0,0,0.3); padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .stats-text { color: #aaa; font-size: 0.9rem; }
        .stats-text span { color: #e94560; font-weight: bold; }
        .results-panel { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: rgba(0,0,0,0.3); padding: 10px 8px; text-align: left; color: #aaa; font-weight: normal; position: sticky; top: 0; }
        td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        tr:hover { background: rgba(255,255,255,0.03); }
        .type-url { color: #6bff6b; }
        .type-fail { color: #ff6b6b; }
        .type-other { color: #ffbb6b; }
        .content-cell { max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .number-cell { font-family: Consolas, monospace; font-size: 0.8rem; color: #888; }
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state .icon { font-size: 3rem; margin-bottom: 15px; }
        .duplicates-info { background: rgba(255,170,0,0.1); border: 1px solid rgba(255,170,0,0.3); border-radius: 6px; padding: 10px 15px; margin-bottom: 15px; color: #ffaa00; display: none; }
        .duplicates-info.show { display: block; }
        .log-box { background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 8px; padding: 10px; height: 120px; overflow-y: auto; font-family: Consolas, monospace; font-size: 0.8rem; margin-top: 10px; }
        .log-info { color: #e0e0e0; }
        .log-success { color: #22c55e; }
        .log-warning { color: #f59e0b; }
        .log-error { color: #ef4444; }
        .scheduler-status { font-size: 0.85rem; color: #60a5fa; margin-top: 10px; text-align: center; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: #1e2030; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 25px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal h3 { margin-bottom: 20px; font-size: 1.2rem; }
        .modal-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .modal-row label { min-width: 120px; font-size: 0.9rem; color: #aaa; }
        .modal-row input { flex: 1; padding: 8px 10px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 5px; color: #fff; text-align: center; font-size: 0.9rem; }
        .modal-row input:focus { outline: none; border-color: #e94560; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
        .modal-check { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .modal-check input[type="checkbox"] { width: 18px; height: 18px; accent-color: #e94560; }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .time-input { min-width: auto !important; width: 140px; flex: none !important; padding: 10px 12px; font-size: 0.95rem; }
        .date-input { min-width: auto !important; width: 170px; flex: none !important; padding: 10px 12px; font-size: 0.95rem; }
        .query-input-lg { padding: 12px 16px; font-size: 1rem; height: 50px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š ç›’è†œè½¨è¿¹è·Ÿè¸ªæŸ¥è¯¢</h1>
        <a href="/">â† è¿”å›é¦–é¡µ</a>
    </div>
    <div class="container">
        <!-- æ•°æ®æŸ¥è¯¢æ¨¡å— -->
        <div class="panel">
            <div class="panel-title">ğŸ” æ•°æ®æŸ¥è¯¢</div>
            <div class="query-row">
                <span class="query-label">æ—¶é—´æ®µ:</span>
                <input type="date" class="query-input date-input" id="processDate">
                <input type="time" class="query-input time-input" id="processStartTime" value="08:00">
                <span style="color:#aaa;">~</span>
                <input type="time" class="query-input time-input" id="processStopTime" value="18:00">
                <button class="btn btn-primary" onclick="queryByDate()">æŸ¥è¯¢</button>
                <button class="btn btn-warning" onclick="queryDuplicates()">æŸ¥é‡å¤</button>
            </div>
            <div class="query-row" style="padding: 12px 0;">
                <span class="query-label">äºŒç»´ç :</span>
                <input type="text" class="query-input query-input-lg" id="contentInput" placeholder="æœç´¢å†…å®¹...">
                <button class="btn btn-primary" onclick="queryByContent()">æŸ¥è¯¢</button>
                <button class="btn btn-danger" onclick="document.getElementById('contentInput').value=''">æ¸…ç©º</button>
            </div>
        </div>

        <!-- InfluxDB è°ƒè¯•é¢æ¿ -->
        <div class="panel" style="display: none;">
            <div class="panel-title">ğŸ—„ï¸ InfluxDB è°ƒè¯•é¢æ¿</div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                <button class="btn btn-primary" onclick="checkInfluxStatus()">ğŸ” æ£€æµ‹è¿æ¥</button>
                <button class="btn btn-success" onclick="queryInfluxSample('bucket_data')">ğŸ“¦ æŸ¥ jbcj01 æ•°æ®</button>
                <button class="btn btn-warning" onclick="queryInfluxSample('bucket_verify')">ğŸ“¦ æŸ¥ jbcj03 æ•°æ®</button>
                <select id="influxHours" class="query-input" style="max-width:120px;">
                    <option value="1">æœ€è¿‘1å°æ—¶</option>
                    <option value="6">æœ€è¿‘6å°æ—¶</option>
                    <option value="24">æœ€è¿‘24å°æ—¶</option>
                    <option value="168">æœ€è¿‘7å¤©</option>
                </select>
            </div>
            <div id="influxStatus" style="margin-bottom: 10px;"></div>
            <div class="log-box" id="influxLog" style="height: 200px; font-size: 0.8rem;"></div>
        </div>

        <!-- ç»Ÿè®¡æ  -->
        <div class="stats-bar">
            <div class="stats-text" id="statsText">å°±ç»ª</div>
            <button class="btn btn-secondary" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>
        <div class="duplicates-info" id="duplicatesInfo"></div>

        <!-- æŸ¥è¯¢ç»“æœ -->
        <div class="results-panel">
            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>ä¸€å·</th><th>äºŒå·</th><th>ä¸‰å·</th><th>å››å·</th><th>äº”å·</th><th>å…­å·</th><th>ä¸ƒå·</th><th>å…«å·</th>
                            <th>æ ¡éªŒä½</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>äºŒç»´ç </th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr><td colspan="12"><div class="empty-state"><div class="icon">ğŸ“‹</div><div>è¯·é€‰æ‹©æŸ¥è¯¢æ¡ä»¶</div></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- è¿è¡Œæ—¥å¿— -->
        <div class="panel" style="margin-top: 15px;">
            <div class="panel-title">ğŸ“ è¿è¡Œæ—¥å¿—</div>
            <div class="log-box" id="logBox"></div>
        </div>

        <!-- ç³»ç»Ÿè®¾ç½®æ¨¡å— -->
        <div class="panel" style="margin-top: 15px;">
            <div class="panel-title">ğŸ”§ ç³»ç»Ÿè®¾ç½®</div>
            <div class="settings-grid">
                <button class="btn btn-secondary btn-block" onclick="openNumberQueryModal()">ğŸ”¢ ç¼–å·æŸ¥è¯¢</button>
                <button class="btn btn-secondary btn-block" onclick="openSettingsModal()">âš™ï¸ è®¾ç½®ä¸Šä¸‹é™</button>
                <button class="btn btn-secondary btn-block" onclick="openSchedulerModal()">â° å®šæ—¶å¤„ç†è®¾ç½®</button>
                <button class="btn btn-secondary btn-block" onclick="openManualNumberModal()">ğŸ”¢ æ‰‹åŠ¨è®¾å®šç¼–å·</button>
                <button class="btn btn-secondary btn-block" onclick="openErrorSettingsModal()">âš ï¸ é”™è¯¯æ—¶è®¾ç½®</button>
            </div>
            <div class="scheduler-status" id="schedulerStatus">â¸ï¸ å®šæ—¶å¤„ç†æœªå¯ç”¨</div>
        </div>
    </div>

    <!-- è®¾ç½®ä¸Šä¸‹é™å¼¹çª— -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h3>âš™ï¸ è®¾ç½®8ä¸ªè½®æ¨¡ç›’çš„ç¼–å·ä¸Šä¸‹é™</h3>
            <div id="settingsRows"></div>
            <div class="modal-btns">
                <button class="btn btn-success" onclick="saveSettings()">ğŸ’¾ ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å®šæ—¶å¤„ç†è®¾ç½®å¼¹çª— -->
    <div class="modal-overlay" id="schedulerModal">
        <div class="modal">
            <h3>â° å®šæ—¶å¤„ç†è®¾ç½®</h3>
            <div class="modal-check">
                <input type="checkbox" id="schedulerEnabled">
                <label>å¯ç”¨å®šæ—¶è‡ªåŠ¨å¤„ç†</label>
            </div>
            <div class="modal-row">
                <label>æ‰§è¡Œé—´éš”:</label>
                <input type="number" id="schedulerHours" min="0" style="width:60px;"> <span style="color:#aaa;">å°æ—¶</span>
                <input type="number" id="schedulerMinutes" min="0" style="width:60px;"> <span style="color:#aaa;">åˆ†é’Ÿ</span>
            </div>
            <div class="modal-check">
                <input type="checkbox" id="schedulerRetry">
                <label>å¤„ç†å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•</label>
            </div>
            <div class="modal-row">
                <label>é‡è¯•é—´éš”(åˆ†é’Ÿ):</label>
                <input type="number" id="schedulerRetryInterval" min="1" style="width:80px;">
            </div>
            <div class="modal-btns">
                <button class="btn btn-success" onclick="saveScheduler()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                <button class="btn btn-secondary" onclick="closeModal('schedulerModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ‰‹åŠ¨è®¾å®šç¼–å·å¼¹çª— -->
    <div class="modal-overlay" id="manualNumberModal">
        <div class="modal">
            <h3>ğŸ”¢ è®¾å®šå„è½®æ¨¡ç›’çš„"æœ€åç¼–å·"</h3>
            <p style="color:#888; font-size:0.85rem; margin-bottom:15px;">ä¸‹æ¬¡å¤„ç†æ—¶å°†ä»æ­¤ç¼–å·+1å¼€å§‹</p>
            <div id="manualNumberRows"></div>
            <div class="modal-btns">
                <button class="btn btn-success" onclick="saveManualNumbers()">ğŸ’¾ ä¿å­˜æ›´æ”¹</button>
                <button class="btn btn-danger" onclick="resetNumbers()">ğŸ—‘ï¸ åˆ é™¤è®°å½•</button>
                <button class="btn btn-secondary" onclick="closeModal('manualNumberModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç¼–å·æŸ¥è¯¢å¼¹çª— -->
    <div class="modal-overlay" id="numberQueryModal">
        <div class="modal">
            <h3>ğŸ”¢ ç¼–å·æŸ¥è¯¢</h3>
            <div class="modal-row">
                <label>é€‰æ‹©è½®æ¨¡ç›’:</label>
                <select class="query-input" id="boxSelect" style="flex:1;">
                    <option value="0">ä¸€å·è½®æ¨¡ç›’</option>
                    <option value="1">äºŒå·è½®æ¨¡ç›’</option>
                    <option value="2">ä¸‰å·è½®æ¨¡ç›’</option>
                    <option value="3">å››å·è½®æ¨¡ç›’</option>
                    <option value="4">äº”å·è½®æ¨¡ç›’</option>
                    <option value="5">å…­å·è½®æ¨¡ç›’</option>
                    <option value="6">ä¸ƒå·è½®æ¨¡ç›’</option>
                    <option value="7">å…«å·è½®æ¨¡ç›’</option>
                </select>
            </div>
            <div class="modal-row">
                <label>ç¼–å·èŒƒå›´:</label>
                <input type="text" class="query-input" id="numberInput" placeholder="å¦‚: 1-100 æˆ– 1,5,10" style="flex:1;">
            </div>
            <div class="modal-btns">
                <button class="btn btn-primary" onclick="queryByNumber();closeModal('numberQueryModal')">ğŸ” æŸ¥è¯¢</button>
                <button class="btn btn-secondary" onclick="queryAll();closeModal('numberQueryModal')">å…¨éƒ¨</button>
                <button class="btn btn-danger" onclick="clearNumberInput()">æ¸…ç©º</button>
                <button class="btn btn-secondary" onclick="closeModal('numberQueryModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- é”™è¯¯æ—¶è®¾ç½®å¼¹çª— -->
    <div class="modal-overlay" id="errorSettingsModal">
        <div class="modal">
            <h3>âš ï¸ æ ¡éªŒé”™è¯¯æ—¶å¤„ç†è®¾ç½®</h3>
            <div class="modal-check">
                <input type="checkbox" id="errorVerifyEnabled">
                <label>å¯ç”¨æ ¡éªŒåŠŸèƒ½</label>
            </div>
            <p style="color:#aaa; font-size:0.85rem; margin-bottom:10px;">å½“æ ¡éªŒå‡ºé”™æ—¶ï¼Œå„è½®æ¨¡ç›’ä»ä»¥ä¸‹æ•°å­—å¼€å§‹å¾ªç¯ï¼š</p>
            <div id="errorSettingsRows"></div>
            <div id="verifyFileStatus" style="margin-top:10px; font-size:0.85rem;"></div>
            <div class="modal-btns">
                <button class="btn btn-success" onclick="saveErrorSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                <button class="btn btn-secondary" onclick="closeModal('errorSettingsModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const BOX_NAMES = ['ä¸€å·è½®æ¨¡ç›’','äºŒå·è½®æ¨¡ç›’','ä¸‰å·è½®æ¨¡ç›’','å››å·è½®æ¨¡ç›’','äº”å·è½®æ¨¡ç›’','å…­å·è½®æ¨¡ç›’','ä¸ƒå·è½®æ¨¡ç›’','å…«å·è½®æ¨¡ç›’'];
        const BOX_COUNT = 8;

        function addLog(msg, level='info') {
            const box = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `<div class="log-${level}">[${time}] ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('processDate').value = today;
            loadSchedulerStatus();
        });

        // ===== æ•°æ®å¤„ç† =====
        async function doProcess() {
            const dateVal = document.getElementById('processDate').value;
            const startTime = document.getElementById('processStartTime').value;
            const stopTime = document.getElementById('processStopTime').value;

            if (!dateVal) { alert('è¯·é€‰æ‹©æ—¥æœŸ'); return false; }
            if (!startTime || !stopTime) { alert('è¯·è®¾ç½®èµ·æ­¢æ—¶é—´'); return false; }
            if (startTime >= stopTime) { alert('å¼€å§‹æ—¶é—´å¿…é¡»æ—©äºç»“æŸæ—¶é—´'); return false; }

            const startISO = `${dateVal}T${startTime}:00+08:00`;
            const stopISO = `${dateVal}T${stopTime}:00+08:00`;

            addLog(`å¼€å§‹å¤„ç†æ•°æ®: ${dateVal} ${startTime} ~ ${stopTime}`);
            try {
                const res = await fetch('/api/urldata/process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ start_time: startISO, stop_time: stopISO })
                });
                const data = await res.json();
                if (data.logs) data.logs.forEach(l => addLog(l.msg, l.level));
                return data.success;
            } catch (e) {
                addLog('å¤„ç†è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
                return false;
            }
        }

        // ===== æŸ¥è¯¢åŠŸèƒ½ =====
        async function queryByDate() {
            const dateVal = document.getElementById('processDate').value;
            if (!dateVal) { alert('è¯·é€‰æ‹©æ—¥æœŸ'); return; }

            // å…ˆå°è¯•æŸ¥è¯¢å·²æœ‰æ•°æ®
            const res = await fetch('/api/urldata/query', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'date', date: dateVal })
            });
            const data = await res.json();

            if (data.results && data.results.length > 0) {
                displayResults(data.results);
                updateStats(data.stats, 'date');
            } else {
                // æ— æ•°æ®ï¼Œè‡ªåŠ¨æ‰§è¡Œå¤„ç†å†æŸ¥è¯¢
                addLog('è¯¥æ—¥æœŸæš‚æ— æ•°æ®ï¼Œè‡ªåŠ¨æ‰§è¡Œå¤„ç†...', 'warning');
                const ok = await doProcess();
                if (ok) {
                    await doQuery({ type: 'date', date: dateVal });
                }
            }
        }

        async function queryByNumber() {
            const number = document.getElementById('numberInput').value.trim();
            if (!number) { alert('è¯·è¾“å…¥ç¼–å·'); return; }
            const boxIndex = parseInt(document.getElementById('boxSelect').value);
            await doQuery({ type: 'number', number, box_index: boxIndex });
        }
        async function queryByContent() {
            const content = document.getElementById('contentInput').value.trim();
            if (!content) { alert('è¯·è¾“å…¥å†…å®¹'); return; }
            await doQuery({ type: 'content', content });
        }
        async function queryDuplicates() {
            const dateVal = document.getElementById('processDate').value;
            if (!dateVal) { alert('è¯·é€‰æ‹©æ—¥æœŸ'); return; }

            // åŒæ ·å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®ï¼Œæ²¡æœ‰å°±å…ˆå¤„ç†
            const res = await fetch('/api/urldata/query', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'date', date: dateVal })
            });
            const data = await res.json();

            if (!data.results || data.results.length === 0) {
                addLog('è¯¥æ—¥æœŸæš‚æ— æ•°æ®ï¼Œè‡ªåŠ¨æ‰§è¡Œå¤„ç†...', 'warning');
                const ok = await doProcess();
                if (!ok) return;
            }
            await doQuery({ type: 'duplicates', date: dateVal });
        }
        async function queryAll() { await doQuery({ type: 'content', content: '' }); }

        function clearNumberInput() {
            document.getElementById('numberInput').value = '';
            document.getElementById('boxSelect').selectedIndex = 0;
        }

        async function doQuery(params) {
            const res = await fetch('/api/urldata/query', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
            const data = await res.json();
            displayResults(data.results);
            updateStats(data.stats, params.type);
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            if (!results || results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12"><div class="empty-state"><div class="icon">ğŸ”</div><div>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•°æ®</div></div></td></tr>';
                return;
            }
            tbody.innerHTML = results.map(item => {
                const typeClass = item.type === 'URL' ? 'type-url' : item.type === 'å¤±è´¥' ? 'type-fail' : 'type-other';
                return `<tr>
                    ${item.numbers.map(n => `<td class="number-cell">${n}</td>`).join('')}
                    <td>${item.verification || 'N/A'}</td>
                    <td>${item.date}</td>
                    <td class="${typeClass}">${item.type}</td>
                    <td class="content-cell" title="${escapeHtml(item.content)}">${escapeHtml(item.content)}</td>
                </tr>`;
            }).join('');
            checkDuplicates(results);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text; return div.innerHTML;
        }

        function updateStats(stats, queryType) {
            const names = { date:'æ—¥æœŸæŸ¥è¯¢', number:'ç¼–å·æŸ¥è¯¢', content:'å†…å®¹æŸ¥è¯¢', duplicates:'é‡å¤æŸ¥è¯¢' };
            document.getElementById('statsText').innerHTML = `${names[queryType]||'æŸ¥è¯¢'} | æ€»è®¡: <span>${stats.total}</span> | URL: <span>${stats.url}</span> | å¤±è´¥: <span>${stats.fail}</span> | å…¶ä»–: <span>${stats.other}</span>`;
        }

        function checkDuplicates(results) {
            const counts = {};
            results.forEach(r => counts[r.content] = (counts[r.content]||0) + 1);
            const dups = Object.entries(counts).filter(([_,c]) => c > 1);
            const info = document.getElementById('duplicatesInfo');
            if (dups.length > 0) {
                info.classList.add('show');
                info.innerHTML = `âš ï¸ å‘ç° ${dups.length} ä¸ªé‡å¤å†…å®¹ï¼Œå…± ${dups.reduce((s,[_,c])=>s+c,0)} æ¡è®°å½•`;
            } else { info.classList.remove('show'); }
        }

        function clearResults() {
            document.getElementById('resultsBody').innerHTML = '<tr><td colspan="12"><div class="empty-state"><div class="icon">ğŸ“‹</div><div>è¯·é€‰æ‹©æŸ¥è¯¢æ¡ä»¶</div></div></td></tr>';
            document.getElementById('statsText').textContent = 'å°±ç»ª';
            document.getElementById('duplicatesInfo').classList.remove('show');
        }

        // ===== å®šæ—¶å™¨çŠ¶æ€ =====
        async function loadSchedulerStatus() {
            try {
                const res = await fetch('/api/urldata/scheduler_status');
                const data = await res.json();
                document.getElementById('schedulerStatus').textContent = data.status || 'â¸ï¸ å®šæ—¶å¤„ç†æœªå¯ç”¨';
            } catch(e) {}
        }

        // ===== InfluxDB è°ƒè¯• =====
        function influxLog(msg, level = 'info') {
            const box = document.getElementById('influxLog');
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `<div class="log-${level}">[${time}] ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        async function checkInfluxStatus() {
            const box = document.getElementById('influxStatus');
            box.innerHTML = '<span style="color:#60a5fa;">æ£€æµ‹ä¸­...</span>';
            influxLog('æ­£åœ¨æ£€æµ‹ InfluxDB è¿æ¥...');
            try {
                const res = await fetch('/api/urldata/influx_status');
                const data = await res.json();
                if (data.success) {
                    let html = `<div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:8px;padding:12px;">`;
                    html += `<div>âœ… æ•°æ®åº“çŠ¶æ€: <b style="color:#22c55e;">${data.status}</b> | ${data.message}</div>`;
                    html += `<div style="margin-top:5px;">ğŸ“¡ åœ°å€: ${data.config.url} | ç»„ç»‡: ${data.config.org}</div>`;
                    for (const [name, info] of Object.entries(data.buckets)) {
                        if (info.connected) {
                            const dataIcon = info.has_recent_data ? 'ğŸ“Š æœ‰æ•°æ®' : 'âš ï¸ æœ€è¿‘1å°æ—¶æ— æ•°æ®';
                            html += `<div style="margin-top:5px;">âœ… Bucket <b>${name}</b>: è¿æ¥æˆåŠŸ | ${dataIcon}</div>`;
                            influxLog(`Bucket '${name}' è¿æ¥æˆåŠŸï¼Œ${info.has_recent_data ? 'æœ‰æ•°æ®' : 'æœ€è¿‘1å°æ—¶æ— æ•°æ®'}`, info.has_recent_data ? 'success' : 'warning');
                        } else {
                            html += `<div style="margin-top:5px;">âŒ Bucket <b>${name}</b>: ${info.error}</div>`;
                            influxLog(`Bucket '${name}' è¿æ¥å¤±è´¥: ${info.error}`, 'error');
                        }
                    }
                    html += `</div>`;
                    box.innerHTML = html;
                    influxLog('è¿æ¥æ£€æµ‹å®Œæˆ', 'success');
                } else {
                    box.innerHTML = `<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:12px;">âŒ ${data.error}</div>`;
                    influxLog('è¿æ¥å¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                box.innerHTML = `<div style="color:#ef4444;">è¯·æ±‚å¤±è´¥: ${e.message}</div>`;
                influxLog('è¯·æ±‚å¼‚å¸¸: ' + e.message, 'error');
            }
        }

        async function queryInfluxSample(bucketKey) {
            const hours = document.getElementById('influxHours').value;
            influxLog(`æŸ¥è¯¢ ${bucketKey} æœ€è¿‘ ${hours} å°æ—¶æ•°æ®...`);
            try {
                const res = await fetch(`/api/urldata/influx_sample?bucket=${bucketKey}&hours=${hours}&limit=20`);
                const data = await res.json();
                if (data.success) {
                    influxLog(`Bucket '${data.bucket}' è¿”å› ${data.count} æ¡è®°å½•`, data.count > 0 ? 'success' : 'warning');
                    if (data.records.length > 0) {
                        data.records.forEach((r, i) => {
                            influxLog(`  [${i+1}] ${r.time} | ${r.measurement}.${r.field} = ${r.value}`);
                        });
                    } else {
                        influxLog('  è¯¥æ—¶é—´èŒƒå›´å†…æ— æ•°æ®', 'warning');
                    }
                } else {
                    influxLog('æŸ¥è¯¢å¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                influxLog('è¯·æ±‚å¼‚å¸¸: ' + e.message, 'error');
            }
        }

        // ===== å¼¹çª—é€šç”¨ =====
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        function openNumberQueryModal() {
            document.getElementById('numberQueryModal').classList.add('show');
        }

        // ===== è®¾ç½®ä¸Šä¸‹é™å¼¹çª— =====
        async function openSettingsModal() {
            const res = await fetch('/api/urldata/settings');
            const cfg = await res.json();
            const container = document.getElementById('settingsRows');
            container.innerHTML = BOX_NAMES.map((name, i) => `
                <div class="modal-row">
                    <label>${name}:</label>
                    <input type="number" id="setMin${i}" value="${cfg.mins[i]}" min="1" style="width:70px;">
                    <span style="color:#aaa;">~</span>
                    <input type="number" id="setMax${i}" value="${cfg.maxs[i]}" min="1" style="width:70px;">
                </div>
            `).join('');
            document.getElementById('settingsModal').classList.add('show');
        }

        async function saveSettings() {
            const mins = [], maxs = [];
            for (let i = 0; i < BOX_COUNT; i++) {
                const mn = parseInt(document.getElementById('setMin'+i).value);
                const mx = parseInt(document.getElementById('setMax'+i).value);
                if (isNaN(mn) || isNaN(mx) || mn <= 0 || mx <= 0) { alert('ä¸Šä¸‹é™å¿…é¡»ä¸ºæ­£æ•°'); return; }
                if (mn > mx) { alert(BOX_NAMES[i] + ' ä¸‹é™ä¸èƒ½å¤§äºä¸Šé™'); return; }
                mins.push(mn); maxs.push(mx);
            }
            const res = await fetch('/api/urldata/settings', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ mins, maxs })
            });
            const data = await res.json();
            if (data.success) { addLog('ä¸Šä¸‹é™è®¾ç½®å·²ä¿å­˜', 'success'); closeModal('settingsModal'); }
            else alert(data.error || 'ä¿å­˜å¤±è´¥');
        }

        // ===== å®šæ—¶å¤„ç†è®¾ç½®å¼¹çª— =====
        async function openSchedulerModal() {
            const res = await fetch('/api/urldata/scheduler_config');
            const cfg = await res.json();
            document.getElementById('schedulerEnabled').checked = cfg.enabled || false;
            document.getElementById('schedulerHours').value = cfg.hours || 1;
            document.getElementById('schedulerMinutes').value = cfg.minutes || 30;
            document.getElementById('schedulerRetry').checked = cfg.retry || true;
            document.getElementById('schedulerRetryInterval').value = cfg.retry_interval || 30;
            document.getElementById('schedulerModal').classList.add('show');
        }

        async function saveScheduler() {
            const h = parseInt(document.getElementById('schedulerHours').value) || 0;
            const m = parseInt(document.getElementById('schedulerMinutes').value) || 0;
            if (h * 60 + m < 5) { alert('æ€»é—´éš”ä¸èƒ½å°‘äº5åˆ†é’Ÿ'); return; }
            const ri = parseInt(document.getElementById('schedulerRetryInterval').value) || 30;
            const res = await fetch('/api/urldata/scheduler_config', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    enabled: document.getElementById('schedulerEnabled').checked,
                    hours: h, minutes: m,
                    retry: document.getElementById('schedulerRetry').checked,
                    retry_interval: ri
                })
            });
            const data = await res.json();
            if (data.success) { addLog('å®šæ—¶å¤„ç†è®¾ç½®å·²ä¿å­˜', 'success'); closeModal('schedulerModal'); loadSchedulerStatus(); }
            else alert(data.error || 'ä¿å­˜å¤±è´¥');
        }

        // ===== æ‰‹åŠ¨è®¾å®šç¼–å·å¼¹çª— =====
        async function openManualNumberModal() {
            const res = await fetch('/api/urldata/last_numbers');
            const cfg = await res.json();
            const container = document.getElementById('manualNumberRows');
            container.innerHTML = BOX_NAMES.map((name, i) => `
                <div class="modal-row">
                    <label>${name}:</label>
                    <input type="number" id="manNum${i}" value="${cfg.numbers[i]}">
                </div>
            `).join('');
            document.getElementById('manualNumberModal').classList.add('show');
        }

        async function saveManualNumbers() {
            const numbers = [];
            for (let i = 0; i < BOX_COUNT; i++) {
                const v = parseInt(document.getElementById('manNum'+i).value);
                if (isNaN(v)) { alert('æ‰€æœ‰ç¼–å·å¿…é¡»æ˜¯æœ‰æ•ˆæ•´æ•°'); return; }
                numbers.push(v);
            }
            const res = await fetch('/api/urldata/last_numbers', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ numbers })
            });
            const data = await res.json();
            if (data.success) { addLog('æ‰‹åŠ¨æ›´æ–°ç¼–å·æˆåŠŸ: ' + numbers.join(','), 'success'); closeModal('manualNumberModal'); }
            else alert(data.error || 'ä¿å­˜å¤±è´¥');
        }

        async function resetNumbers() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤ç¼–å·è®°å½•æ–‡ä»¶å—ï¼Ÿä¸‹æ¬¡å¤„ç†å°†ä»ä¸‹é™å¼€å§‹ã€‚')) return;
            const res = await fetch('/api/urldata/last_numbers', { method: 'DELETE' });
            const data = await res.json();
            if (data.success) { addLog('ç¼–å·è®°å½•å·²åˆ é™¤', 'success'); closeModal('manualNumberModal'); }
        }

        // ===== é”™è¯¯æ—¶è®¾ç½®å¼¹çª— =====
        async function openErrorSettingsModal() {
            const res = await fetch('/api/urldata/error_settings');
            const cfg = await res.json();
            document.getElementById('errorVerifyEnabled').checked = cfg.enabled;
            const container = document.getElementById('errorSettingsRows');
            container.innerHTML = BOX_NAMES.map((name, i) => `
                <div class="modal-row">
                    <label>${name}:</label>
                    <input type="number" id="errSet${i}" value="${cfg.error_settings[i]}" min="1">
                </div>
            `).join('');
            document.getElementById('verifyFileStatus').innerHTML = cfg.verify_file_status || '';
            document.getElementById('errorSettingsModal').classList.add('show');
        }

        async function saveErrorSettings() {
            const settings = [];
            for (let i = 0; i < BOX_COUNT; i++) {
                const v = parseInt(document.getElementById('errSet'+i).value);
                if (isNaN(v) || v <= 0) { alert('ç¼–å·å¿…é¡»ä¸ºæ­£æ•°'); return; }
                settings.push(v);
            }
            const res = await fetch('/api/urldata/error_settings', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    enabled: document.getElementById('errorVerifyEnabled').checked,
                    error_settings: settings
                })
            });
            const data = await res.json();
            if (data.success) { addLog('é”™è¯¯å¤„ç†è®¾ç½®å·²ä¿å­˜', 'success'); closeModal('errorSettingsModal'); }
            else alert(data.error || 'ä¿å­˜å¤±è´¥');
        }
    </script>
</body>
</html>