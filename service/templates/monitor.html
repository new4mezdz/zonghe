<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCPç½‘ç»œè°ƒè¯•åŠ©æ‰‹</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: #2b2b2b; min-height: 100vh; color: #fff; }
        .header { background: #383838; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #ffae00; }
        .header h1 { color: #fff; font-size: 1.5rem; }
        .header a { color: #ffae00; text-decoration: none; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* é¡¶éƒ¨åŒè¿æ¥åŒº */
        .connection-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }

        /* é¢æ¿ */
        .panel { background: #383838; border-radius: 8px; padding: 15px; }
        .panel-title {
            color: #ffae00; font-size: 0.95rem; font-weight: bold;
            margin-bottom: 12px; padding-bottom: 8px;
            border-bottom: 1px solid #555;
            display: flex; align-items: center; gap: 8px;
        }
        .panel-title .icon { font-size: 1.1rem; }

        /* è¡¨å• */
        .form-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .form-row:last-child { margin-bottom: 0; }
        .form-row label { color: #ccc; font-size: 0.85rem; white-space: nowrap; min-width: 40px; }
        .form-row input[type="text"],
        .form-row input[type="number"] {
            background: #1e1e1e; border: 1px solid #555; color: #fff;
            padding: 8px 12px; border-radius: 4px; font-size: 0.9rem; flex: 1;
        }
        .form-row input:focus { border-color: #ffae00; outline: none; }

        /* æŒ‰é’® */
        .btn {
            padding: 8px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; font-size: 0.85rem;
            transition: all 0.2s;
        }
        .btn:hover { filter: brightness(1.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #ffae00; color: #000; }
        .btn-success { background: #4CAF50; color: #fff; }
        .btn-danger { background: #f44336; color: #fff; }
        .btn-secondary { background: #555; color: #fff; }
        .btn-sm { padding: 5px 12px; font-size: 0.8rem; }
        .btn-block { width: 100%; }

        /* çŠ¶æ€å¾½ç«  */
        .status-badge {
            padding: 4px 12px; border-radius: 12px; font-size: 0.8rem;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .status-badge::before { content: ""; width: 6px; height: 6px; border-radius: 50%; }
        .status-disconnected { background: #444; color: #aaa; }
        .status-disconnected::before { background: #666; }
        .status-connecting { background: #4a4a00; color: #ffae00; }
        .status-connecting::before { background: #ffae00; animation: blink 1s infinite; }
        .status-connected { background: #1a3d1a; color: #4CAF50; }
        .status-connected::before { background: #4CAF50; }
        .status-error { background: #3d1a1a; color: #ff4d4d; }
        .status-error::before { background: #ff4d4d; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* ä¸»å¸ƒå±€ */
        .main-layout { display: grid; grid-template-columns: 260px 1fr 260px; gap: 20px; }

        /* æ•°æ®æ˜¾ç¤ºåŒº */
        .data-box {
            background: #1e1e1e; border-radius: 6px; padding: 12px;
            font-family: Consolas, 'Courier New', monospace; font-size: 0.85rem;
            height: 350px; overflow-y: auto; color: #e0e0e0;
            border: 1px solid #444;
        }
        .data-box.wrap { white-space: pre-wrap; word-break: break-all; }

        .log-line { padding: 3px 0; border-bottom: 1px solid #333; }
        .log-time { color: #888; margin-right: 8px; }
        .log-server-rx { color: #4CAF50; }
        .log-server-tx { color: #8BC34A; }
        .log-client-rx { color: #2196F3; }
        .log-client-tx { color: #03A9F4; }
        .log-sys { color: #ff9800; }
        .log-hex { color: #666; font-size: 0.75rem; display: block; margin-left: 95px; }

        /* å‘é€åŒº */
        .send-section { margin-top: 15px; }
        .send-input {
            width: 100%; background: #1e1e1e; border: 1px solid #555;
            color: #fff; padding: 10px; border-radius: 4px;
            font-family: Consolas, monospace; font-size: 0.9rem;
            resize: vertical; min-height: 50px;
        }
        .send-input:focus { border-color: #ffae00; outline: none; }
        .send-row { display: flex; gap: 10px; margin-top: 10px; align-items: center; }
        .send-row select {
            background: #1e1e1e; border: 1px solid #555; color: #fff;
            padding: 8px 12px; border-radius: 4px;
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel { display: flex; flex-direction: column; gap: 15px; }
        .option-list { display: flex; flex-direction: column; gap: 6px; }
        .option-item { display: flex; align-items: center; gap: 6px; }
        .option-item label { color: #aaa; font-size: 0.8rem; cursor: pointer; }
        .option-item input[type="checkbox"] { accent-color: #ffae00; }
        .radio-group { display: flex; gap: 12px; }
        .radio-group label { display: flex; align-items: center; gap: 4px; color: #aaa; font-size: 0.8rem; cursor: pointer; }
        .radio-group input { accent-color: #ffae00; }

        /* ç»Ÿè®¡æ  */
        .stats-bar {
            display: flex; gap: 15px; padding: 8px 12px;
            background: #2a2a2a; border-radius: 4px; font-size: 0.75rem; color: #888;
            margin-top: 10px; flex-wrap: wrap;
        }
        .stats-bar span { color: #ffae00; font-weight: bold; }

        /* å¿«æ·æŒ‡ä»¤ */
        .shortcut-list { max-height: 120px; overflow-y: auto; background: #1e1e1e; border-radius: 4px; padding: 8px; }
        .shortcut-item {
            display: flex; align-items: center; gap: 6px;
            padding: 4px; border-radius: 4px; margin-bottom: 3px; background: #2a2a2a;
        }
        .shortcut-item:hover { background: #333; }
        .shortcut-item .cmd { flex: 1; font-family: monospace; font-size: 0.75rem; color: #ccc; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* è­¦å‘Šæ¡† */
        .alert-box {
            background: #3d2020; border: 1px solid #ff4d4d;
            border-radius: 6px; padding: 10px; display: none; margin-top: 15px;
        }
        .alert-box.show { display: block; }
        .alert-title { color: #ff4d4d; font-weight: bold; font-size: 0.85rem; }
        .alert-content { font-size: 0.8rem; color: #ffaaaa; max-height: 80px; overflow-y: auto; margin-top: 5px; }

        input[type="file"] { display: none; }

        .btn-link { background: none; color: #ffae00; padding: 2px 0; text-decoration: underline; cursor: pointer; border: none; font-size: 0.8rem; }

        /* å“åº”å¼ */
        @media (max-width: 1100px) {
            .main-layout { grid-template-columns: 1fr; }
            .connection-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“¡ TCPç½‘ç»œè°ƒè¯•åŠ©æ‰‹</h1>
        <a href="/">â† è¿”å›é¦–é¡µ</a>
    </div>

    <div class="container">
        <!-- åŒè¿æ¥è®¾ç½®åŒº -->
        <div class="connection-row">
            <!-- æœåŠ¡å™¨æ¨¡å¼ (æ¥æ”¶å¤–éƒ¨è¿æ¥) -->
            <div class="panel">
                <div class="panel-title">
                    <span class="icon">ğŸ“¥</span> TCPæœåŠ¡å™¨ï¼ˆæ¥æ”¶æ•°æ®ï¼‰
                </div>
                <div class="form-row">
                    <label>IP:</label>
                    <input type="text" id="serverIp" value="0.0.0.0" style="width:140px;">
                    <label>ç«¯å£:</label>
                    <input type="number" id="serverPort" value="8080" style="width:80px;">
                    <button class="btn btn-success" id="serverBtn" onclick="toggleServer()">å¯åŠ¨ç›‘å¬</button>
                </div>
                <div class="form-row" style="margin-top:8px;">
                    <span style="color:#888; font-size:0.8rem;">çŠ¶æ€:</span>
                    <span class="status-badge status-disconnected" id="serverStatus">æœªå¯åŠ¨</span>
                </div>
            </div>

            <!-- å®¢æˆ·ç«¯æ¨¡å¼ (è¿æ¥åˆ°å¤–éƒ¨) -->
            <div class="panel">
                <div class="panel-title">
                    <span class="icon">ğŸ“¤</span> TCPå®¢æˆ·ç«¯ï¼ˆå‘é€æ•°æ®ï¼‰
                </div>
                <div class="form-row">
                    <label>IP:</label>
                    <input type="text" id="clientIp" value="127.0.0.1" style="width:140px;">
                    <label>ç«¯å£:</label>
                    <input type="number" id="clientPort" value="9000" style="width:80px;">
                    <button class="btn btn-success" id="clientBtn" onclick="toggleClient()">è¿æ¥</button>
                </div>
                <div class="form-row" style="margin-top:8px;">
                    <span style="color:#888; font-size:0.8rem;">çŠ¶æ€:</span>
                    <span class="status-badge status-disconnected" id="clientStatus">æœªè¿æ¥</span>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-layout">
            <!-- å·¦ä¾§è®¾ç½® -->
            <div class="settings-panel">
                <!-- æ¥æ”¶è®¾ç½® -->
                <div class="panel">
                    <div class="panel-title">ğŸ“¥ æ¥æ”¶è®¾ç½®</div>
                    <div class="form-row">
                        <div class="radio-group">
                            <label><input type="radio" name="rxFormat" value="ascii" checked> ASCII</label>
                            <label><input type="radio" name="rxFormat" value="hex"> HEX</label>
                        </div>
                    </div>
                    <div class="option-list">
                        <div class="option-item">
                            <input type="checkbox" id="rxShowTime" checked>
                            <label for="rxShowTime">æ˜¾ç¤ºæ—¶é—´æˆ³</label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="rxShowHex">
                            <label for="rxShowHex">åŒæ—¶æ˜¾ç¤ºHEX</label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="rxAutoScroll" checked>
                            <label for="rxAutoScroll">è‡ªåŠ¨æ»šå±</label>
                        </div>
                    </div>
                    <div style="margin-top:10px;">
                        <button class="btn btn-secondary btn-sm" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                        <button class="btn btn-secondary btn-sm" onclick="downloadLog()">å¯¼å‡º</button>
                    </div>
                </div>

                <!-- å‘é€è®¾ç½® -->
                <div class="panel">
                    <div class="panel-title">ğŸ“¤ å‘é€è®¾ç½®</div>
                    <div class="form-row">
                        <div class="radio-group">
                            <label><input type="radio" name="txFormat" value="ascii" checked> ASCII</label>
                            <label><input type="radio" name="txFormat" value="hex"> HEX</label>
                        </div>
                    </div>
                    <div class="option-list">
                        <div class="option-item">
                            <input type="checkbox" id="txParseEscape">
                            <label for="txParseEscape">è½¬ä¹‰ç¬¦è§£æ</label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="txAppendNewline" checked>
                            <label for="txAppendNewline">è‡ªåŠ¨åŠ æ¢è¡Œ</label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="txCycleEnable">
                            <label for="txCycleEnable">å¾ªç¯å‘é€</label>
                            <input type="number" id="txCycleMs" value="1000" min="100" style="width:60px; padding:4px; background:#1e1e1e; border:1px solid #555; color:#fff; border-radius:3px;">
                            <span style="color:#888;font-size:0.75rem;">ms</span>
                        </div>
                    </div>
                </div>

                <!-- é»‘åå• -->
                <div class="panel">
                    <div class="panel-title">ğŸš« é»‘åå•æ£€æµ‹</div>
                    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('blacklistFile').click()">å¯¼å…¥</button>
                    <input type="file" id="blacklistFile" accept=".txt">
                    <div style="margin-top:6px; font-size:0.75rem; color:#888;" id="blacklistInfo">æœªå¯¼å…¥</div>
                </div>
            </div>

            <!-- ä¸­é—´æ•°æ®åŒº -->
            <div>
                <div class="panel">
                    <div class="panel-title">ğŸ“‹ æ•°æ®æ—¥å¿—</div>
                    <div class="data-box wrap" id="dataLog">
                        <div style="color:#666; text-align:center; padding-top:140px;">ç­‰å¾…è¿æ¥...</div>
                    </div>
                    <div class="stats-bar">
                        <div>æœåŠ¡å™¨ RX: <span id="srvRxCount">0</span>æ¡ / <span id="srvRxBytes">0</span>B</div>
                        <div>æœåŠ¡å™¨ TX: <span id="srvTxCount">0</span>æ¡ / <span id="srvTxBytes">0</span>B</div>
                        <div>å®¢æˆ·ç«¯ RX: <span id="cltRxCount">0</span>æ¡ / <span id="cltRxBytes">0</span>B</div>
                        <div>å®¢æˆ·ç«¯ TX: <span id="cltTxCount">0</span>æ¡ / <span id="cltTxBytes">0</span>B</div>
                    </div>
                </div>

                <!-- è­¦å‘Šæ¡† -->
                <div class="alert-box" id="alertBox">
                    <div class="alert-title">âš ï¸ é»‘åå•è­¦å‘Š</div>
                    <div class="alert-content" id="alertContent"></div>
                </div>

                <!-- å‘é€åŒº -->
                <div class="panel send-section">
                    <div class="panel-title">âœï¸ æ•°æ®å‘é€</div>
                    <textarea class="send-input" id="sendInput" placeholder="è¾“å…¥è¦å‘é€çš„æ•°æ®...ï¼ˆCtrl+Enterå‘é€ï¼‰"></textarea>
                    <div class="send-row">
                        <select id="sendChannel">
                            <option value="server">é€šè¿‡æœåŠ¡å™¨å‘é€ï¼ˆå›å¤å®¢æˆ·ç«¯ï¼‰</option>
                            <option value="client">é€šè¿‡å®¢æˆ·ç«¯å‘é€ï¼ˆå‘ç»™ç›®æ ‡æœºå™¨ï¼‰</option>
                        </select>
                        <button class="btn btn-primary" id="sendBtn" onclick="sendData()">å‘é€</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('sendInput').value=''">æ¸…ç©º</button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§å¿«æ·æŒ‡ä»¤ -->
            <div class="settings-panel">
                <div class="panel">
                    <div class="panel-title">
                        âš¡ å¿«æ·æŒ‡ä»¤
                        <button class="btn-link" style="margin-left:auto;" onclick="addShortcut()">+ æ·»åŠ </button>
                    </div>
                    <div class="shortcut-list" id="shortcutList">
                        <div style="color:#666; font-size:0.75rem; text-align:center; padding:15px 0;">æš‚æ— </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">
                        ğŸ“œ å‘é€å†å²
                        <button class="btn-link" style="margin-left:auto;" onclick="clearHistory()">æ¸…ç©º</button>
                    </div>
                    <div class="shortcut-list" id="historyList">
                        <div style="color:#666; font-size:0.75rem; text-align:center; padding:15px 0;">æš‚æ— </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">ğŸ“ æ–‡ä»¶å‘é€</div>
                    <button class="btn btn-secondary btn-sm btn-block" onclick="document.getElementById('txFileInput').click()">æ‰“å¼€æ–‡ä»¶</button>
                    <input type="file" id="txFileInput" accept=".txt,.dat,.hex">
                </div>
            </div>
        </div>
    </div>
<script>
        const socket = io();
        let serverRunning = false, serverConnected = false;
        let clientConnected = false;
        let cycleTimer = null;

        // ç»Ÿè®¡
        let stats = {
            srvRx: 0, srvRxB: 0, srvTx: 0, srvTxB: 0,
            cltRx: 0, cltRxB: 0, cltTx: 0, cltTxB: 0
        };

        // å¿«æ·æŒ‡ä»¤å’Œå†å²è®°å½•ï¼ˆä»åç«¯åŠ è½½ï¼‰
        let shortcuts = [];
        let sendHistory = [];

        // ===== åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', async () => {
            await loadShortcuts();
            await loadHistory();
            await loadBlacklist();
            socket.emit('tcp_get_status');
        });

        // ===== ä»åç«¯åŠ è½½æ•°æ® =====
        async function loadShortcuts() {
            try {
                const res = await fetch('/api/monitor/shortcuts');
                const data = await res.json();
                if (data.success) {
                    shortcuts = data.shortcuts;
                    renderShortcuts();
                }
            } catch (e) {
                console.error('åŠ è½½å¿«æ·æŒ‡ä»¤å¤±è´¥:', e);
            }
        }

        async function loadHistory() {
            try {
                const res = await fetch('/api/monitor/history');
                const data = await res.json();
                if (data.success) {
                    sendHistory = data.history;
                    renderHistory();
                }
            } catch (e) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
            }
        }

        async function loadBlacklist() {
            try {
                const res = await fetch('/api/monitor/blacklist');
                const data = await res.json();
                if (data.success && data.count > 0) {
                    document.getElementById('blacklistInfo').textContent = `å·²åŠ è½½ ${data.count} æ¡`;
                }
            } catch (e) {
                console.error('åŠ è½½é»‘åå•å¤±è´¥:', e);
            }
        }

        // ===== TCPçŠ¶æ€å¤„ç† =====
        socket.on('tcp_status', (data) => {
            const channel = data.channel;
            const status = data.status;
            const msg = data.msg;

            if (channel === 'server') {
                const statusEl = document.getElementById('serverStatus');
                const btn = document.getElementById('serverBtn');

                statusEl.textContent = msg;
                statusEl.className = 'status-badge';

                if (status === 'connected') {
                    statusEl.classList.add('status-connected');
                    btn.textContent = 'åœæ­¢';
                    btn.className = 'btn btn-danger';
                    serverRunning = true;
                    serverConnected = true;
                } else if (status === 'listening') {
                    statusEl.classList.add('status-connecting');
                    btn.textContent = 'åœæ­¢';
                    btn.className = 'btn btn-danger';
                    serverRunning = true;
                    serverConnected = false;
                } else if (status === 'disconnected') {
                    statusEl.classList.add('status-disconnected');
                    btn.textContent = 'å¯åŠ¨ç›‘å¬';
                    btn.className = 'btn btn-success';
                    serverRunning = false;
                    serverConnected = false;
                } else if (status === 'error') {
                    statusEl.classList.add('status-error');
                }

                addLog('SYS', `[æœåŠ¡å™¨] ${msg}`, 'sys');

            } else if (channel === 'client') {
                const statusEl = document.getElementById('clientStatus');
                const btn = document.getElementById('clientBtn');

                statusEl.textContent = msg;
                statusEl.className = 'status-badge';

                if (status === 'connected') {
                    statusEl.classList.add('status-connected');
                    btn.textContent = 'æ–­å¼€';
                    btn.className = 'btn btn-danger';
                    clientConnected = true;
                } else if (status === 'disconnected') {
                    statusEl.classList.add('status-disconnected');
                    btn.textContent = 'è¿æ¥';
                    btn.className = 'btn btn-success';
                    clientConnected = false;
                } else if (status === 'error') {
                    statusEl.classList.add('status-error');
                }

                addLog('SYS', `[å®¢æˆ·ç«¯] ${msg}`, 'sys');
            }
        });

        // æ¥æ”¶æ•°æ®
        socket.on('tcp_receive', (data) => {
            const channel = data.channel;
            const format = document.querySelector('input[name="rxFormat"]:checked').value;
            const displayData = format === 'hex' ? data.hex : data.data;
            const showHex = document.getElementById('rxShowHex').checked && format === 'ascii';

            if (channel === 'server') {
                stats.srvRx++;
                stats.srvRxB += data.length;
                addLog('SRV-RX', displayData, 'server-rx', showHex ? data.hex : null);
            } else {
                stats.cltRx++;
                stats.cltRxB += data.length;
                addLog('CLT-RX', displayData, 'client-rx', showHex ? data.hex : null);
            }

            updateStats();
        });

        // å‘é€ç¡®è®¤
        socket.on('tcp_sent', (data) => {
            const channel = data.channel;
            const format = document.querySelector('input[name="txFormat"]:checked').value;
            const displayData = format === 'hex' ? data.hex : data.data;

            if (channel === 'server') {
                stats.srvTx++;
                stats.srvTxB += data.length;
                addLog('SRV-TX', displayData, 'server-tx');
            } else {
                stats.cltTx++;
                stats.cltTxB += data.length;
                addLog('CLT-TX', displayData, 'client-tx');
            }

            updateStats();
            // é‡æ–°åŠ è½½å†å²è®°å½•
            loadHistory();
        });

        // é»‘åå•è­¦å‘Š
        socket.on('blacklist_alert', (data) => {
            document.getElementById('alertBox').classList.add('show');
            const content = document.getElementById('alertContent');
            data.items.forEach(item => {
                content.innerHTML += `[${new Date().toLocaleTimeString()}] ${escapeHtml(item)}<br>`;
            });
        });

        // ===== è¿æ¥æ§åˆ¶ =====
        function toggleServer() {
            if (serverRunning) {
                socket.emit('tcp_server_stop');
            } else {
                socket.emit('tcp_server_start', {
                    ip: document.getElementById('serverIp').value,
                    port: document.getElementById('serverPort').value
                });
            }
        }

        function toggleClient() {
            if (clientConnected) {
                socket.emit('tcp_client_disconnect');
            } else {
                socket.emit('tcp_client_connect', {
                    ip: document.getElementById('clientIp').value,
                    port: document.getElementById('clientPort').value
                });
            }
        }

        // ===== å‘é€æ•°æ® =====
        function sendData() {
            let content = document.getElementById('sendInput').value;
            if (!content) return;

            const channel = document.getElementById('sendChannel').value;
            const isHex = document.querySelector('input[name="txFormat"]:checked').value === 'hex';
            const parseEscape = document.getElementById('txParseEscape').checked;
            const appendNewline = document.getElementById('txAppendNewline').checked;

            if (!isHex && parseEscape) {
                content = content.replace(/\\r/g, '\r').replace(/\\n/g, '\n').replace(/\\t/g, '\t');
            }

            socket.emit('tcp_send', {
                channel: channel,
                content: content,
                hex: isHex,
                newline: appendNewline && !isHex
            });
        }

        // å¾ªç¯å‘é€
        document.getElementById('txCycleEnable').addEventListener('change', function() {
            if (this.checked) {
                const ms = parseInt(document.getElementById('txCycleMs').value) || 1000;
                cycleTimer = setInterval(sendData, Math.max(ms, 100));
            } else {
                if (cycleTimer) { clearInterval(cycleTimer); cycleTimer = null; }
            }
        });

        // Ctrl+Enterå‘é€
        document.getElementById('sendInput').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') sendData();
        });

        // ===== æ—¥å¿—æ˜¾ç¤º =====
        function addLog(dir, data, type, hexData) {
            const log = document.getElementById('dataLog');
            const showTime = document.getElementById('rxShowTime').checked;

            if (log.querySelector('div[style*="text-align"]')) {
                log.innerHTML = '';
            }

            const time = new Date();
            const timeStr = time.toLocaleTimeString('zh-CN', { hour12: false }) + '.' +
                           String(time.getMilliseconds()).padStart(3, '0');

            const line = document.createElement('div');
            line.className = 'log-line';

            let html = '';
            if (showTime) html += `<span class="log-time">[${timeStr}]</span>`;
            html += `<span class="log-${type}">[${dir}]</span> `;
            html += escapeHtml(data);
            if (hexData) html += `<span class="log-hex">[HEX] ${hexData}</span>`;

            line.innerHTML = html;
            log.appendChild(line);

            if (document.getElementById('rxAutoScroll').checked) {
                log.scrollTop = log.scrollHeight;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function clearLog() {
            document.getElementById('dataLog').innerHTML = '<div style="color:#666; text-align:center; padding-top:140px;">æ—¥å¿—å·²æ¸…ç©º</div>';
            stats = { srvRx: 0, srvRxB: 0, srvTx: 0, srvTxB: 0, cltRx: 0, cltRxB: 0, cltTx: 0, cltTxB: 0 };
            updateStats();
            // åŒæ—¶æ¸…ç©ºåç«¯æ—¥å¿—
            await fetch('/api/monitor/logs', { method: 'DELETE' });
        }

        function updateStats() {
            document.getElementById('srvRxCount').textContent = stats.srvRx;
            document.getElementById('srvRxBytes').textContent = stats.srvRxB;
            document.getElementById('srvTxCount').textContent = stats.srvTx;
            document.getElementById('srvTxBytes').textContent = stats.srvTxB;
            document.getElementById('cltRxCount').textContent = stats.cltRx;
            document.getElementById('cltRxBytes').textContent = stats.cltRxB;
            document.getElementById('cltTxCount').textContent = stats.cltTx;
            document.getElementById('cltTxBytes').textContent = stats.cltTxB;
        }

        async function downloadLog() {
            window.location.href = '/api/monitor/logs/export';
        }

        // ===== é»‘åå•ï¼ˆæ”¹ä¸ºåç«¯å¤„ç†ï¼‰ =====
        document.getElementById('blacklistFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/monitor/blacklist', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('blacklistInfo').textContent = `å·²åŠ è½½ ${data.count} æ¡`;
                }
            } catch (e) {
                console.error('ä¸Šä¼ é»‘åå•å¤±è´¥:', e);
            }
        });

        // ===== å¿«æ·æŒ‡ä»¤ï¼ˆæ”¹ä¸ºåç«¯å¤„ç†ï¼‰ =====
        function renderShortcuts() {
            const list = document.getElementById('shortcutList');
            if (shortcuts.length === 0) {
                list.innerHTML = '<div style="color:#666; font-size:0.75rem; text-align:center; padding:15px 0;">æš‚æ— </div>';
                return;
            }
            list.innerHTML = shortcuts.map((cmd, i) => `
                <div class="shortcut-item">
                    <span class="cmd" title="${escapeHtml(cmd)}">${escapeHtml(cmd)}</span>
                    <button class="btn btn-primary btn-sm" onclick="useShortcut(${i})" style="padding:2px 8px;">å‘</button>
                    <button class="btn btn-secondary btn-sm" onclick="deleteShortcut(${i})" style="padding:2px 6px;">Ã—</button>
                </div>
            `).join('');
        }

        async function addShortcut() {
            const cmd = prompt('è¾“å…¥å¿«æ·æŒ‡ä»¤:');
            if (cmd && cmd.trim()) {
                try {
                    const res = await fetch('/api/monitor/shortcuts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cmd: cmd.trim() })
                    });
                    const data = await res.json();
                    if (data.success) {
                        shortcuts = data.shortcuts;
                        renderShortcuts();
                    }
                } catch (e) {
                    console.error('æ·»åŠ å¿«æ·æŒ‡ä»¤å¤±è´¥:', e);
                }
            }
        }

        function useShortcut(i) {
            document.getElementById('sendInput').value = shortcuts[i];
            sendData();
        }

        async function deleteShortcut(i) {
            try {
                const res = await fetch(`/api/monitor/shortcuts/${i}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    shortcuts = data.shortcuts;
                    renderShortcuts();
                }
            } catch (e) {
                console.error('åˆ é™¤å¿«æ·æŒ‡ä»¤å¤±è´¥:', e);
            }
        }

        // ===== å†å²è®°å½•ï¼ˆæ”¹ä¸ºåç«¯å¤„ç†ï¼‰ =====
        function renderHistory() {
            const list = document.getElementById('historyList');
            if (sendHistory.length === 0) {
                list.innerHTML = '<div style="color:#666; font-size:0.75rem; text-align:center; padding:15px 0;">æš‚æ— </div>';
                return;
            }
            list.innerHTML = sendHistory.slice(-15).reverse().map(cmd => `
                <div class="shortcut-item" onclick="document.getElementById('sendInput').value='${escapeHtml(cmd)}'">
                    <span class="cmd">${escapeHtml(cmd)}</span>
                </div>
            `).join('');
        }

        async function clearHistory() {
            if (!confirm('æ¸…ç©ºå†å²è®°å½•ï¼Ÿ')) return;
            try {
                await fetch('/api/monitor/history', { method: 'DELETE' });
                sendHistory = [];
                renderHistory();
            } catch (e) {
                console.error('æ¸…ç©ºå†å²è®°å½•å¤±è´¥:', e);
            }
        }

        // ===== æ–‡ä»¶å‘é€ =====
        document.getElementById('txFileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) document.getElementById('sendInput').value = await file.text();
        });
    </script>
</body>
</html>
