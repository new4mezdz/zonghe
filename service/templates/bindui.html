<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœºå°ç¦»å²—ç»Ÿè®¡</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #eaeaea; }
        .header { background: rgba(255,255,255,0.05); padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header h1 { font-size: 1.8rem; }
        .header a { color: #e94560; text-decoration: none; margin-left: 20px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        .panel { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .panel-title { font-size: 1.1rem; margin-bottom: 15px; color: #aaa; }
        .control-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #e94560; color: #fff; }
        .btn-primary:hover { background: #d63850; }
        .btn-secondary { background: #444; color: #fff; }
        .file-label { color: #aaa; margin-left: 10px; }
        .chart-container { background: #fff; border-radius: 12px; padding: 20px; margin-top: 20px; }
        input[type="file"] { display: none; }
        input[type="date"] { padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 6px; color: #fff; }
        select { padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 6px; color: #fff; }
        .stats-info { margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; color: #aaa; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š å„æœºå°ç¦»å²—æƒ…å†µç»Ÿè®¡</h1>
        <a href="/">â† è¿”å›é¦–é¡µ</a>
    </div>
    <div class="container">
        <div class="panel">
            <div class="panel-title">æ•°æ®æ–‡ä»¶</div>
            <div class="control-row">
                <input type="file" id="csvFile" accept=".csv">
                <button class="btn btn-primary" onclick="document.getElementById('csvFile').click()">é€‰æ‹©CSVæ–‡ä»¶</button>
                <span class="file-label" id="fileLabel">æœªé€‰æ‹©æ–‡ä»¶</span>
            </div>
            <div class="stats-info" id="fileInfo" style="display:none;"></div>
        </div>

        <div class="panel">
            <div class="panel-title">ç­›é€‰è®¾ç½®</div>
            <div class="control-row">
                <label style="color:#aaa;">æ—¥æœŸèŒƒå›´:</label>
                <input type="date" id="startDate" value="2025-01-01">
                <span style="color:#aaa;">è‡³</span>
                <input type="date" id="endDate" value="2025-12-31">
                <label style="color:#aaa; margin-left:20px;">ç­æ¬¡:</label>
                <select id="shiftSelect">
                    <option value="å…¨å¤©">å…¨å¤©</option>
                    <option value="ç™½ç­">ç™½ç­</option>
                    <option value="æ™šç­">æ™šç­</option>
                </select>
                <button class="btn btn-primary" onclick="bindui()">åˆ·æ–°å›¾è¡¨</button>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">ç»Ÿè®¡å›¾è¡¨</div>
            <div class="chart-container">
                <canvas id="bindui"></canvas>
            </div>
        </div>
    </div>

    <script>
        let bindui = null;

        document.getElementById('csvFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const res = await fetch('/api/bindui/upload', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.success) {
                document.getElementById('fileLabel').textContent = file.name;
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('fileInfo').innerHTML = `å·²åŠ è½½ <b>${data.rows}</b> è¡Œæ•°æ®ï¼Œåˆ—: ${data.columns.join(', ')}`;
                bindui();
            }
        });

        async function bindui() {
            const res = await fetch('/api/bindui/bindui', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    start_date: document.getElementById('startDate').value,
                    end_date: document.getElementById('endDate').value,
                    shift: document.getElementById('shiftSelect').value
                })
            });

            const result = await res.json();
            if (!result.success) {
                alert(result.error || 'æŸ¥è¯¢å¤±è´¥');
                return;
            }

            const labels = result.data.map(d => d.machine);
            const values = result.data.map(d => d.count);

            const ctx = document.getElementById('bindui').getContext('2d');

            if (bindui) bindui.destroy();

            bindui = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'äº‹ä»¶æ¬¡æ•°',
                        data: values,
                        backgroundColor: '#5C6BC0',
                        borderColor: '#3949AB',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'å„æœºå°ç¦»å²—æƒ…å†µç»Ÿè®¡',
                            font: { size: 18 }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    </script>
</body>
</html>